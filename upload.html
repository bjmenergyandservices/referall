<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Post Your Listing - REFERALLS</title>
<style>
  body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #f4f6f8; }
  header { background: #1e2c1e; color: white; text-align: center; padding: 15px; }
  .nav-btn { display: block; width: fit-content; margin: 20px auto 0 auto; background: #000000; color: white; padding: 10px 18px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; text-decoration: none; }
  .nav-btn:hover { background: #e69500; }
  .upload-container { max-width: 500px; background: white; margin: 30px auto; padding: 25px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  h2 { text-align: center; color: #333; }
  form { display: flex; flex-direction: column; gap: 15px; }
  input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; }
  button { background: #0b3fea; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
  button:hover { background: #006400; }
  .success, .error { text-align: center; padding: 10px; border-radius: 6px; }
  .success { background: #d4edda; color: #155724; }
  .error { background: #f8d7da; color: #721c24; }
</style>
</head>
<body>

<header>
  <h1>Post Your Listing on REFERALLS</h1>
</header>

<a href="index.html" class="nav-btn">← Back to Dashboard</a>

<div class="upload-container">
  <h2>Upload Your Car or House</h2>

  <form id="uploadForm">
   <select name="category" required>
      <option value="">Select Category</option>
      <option value="House">House</option>
      <option value="Car">Car</option>
    </select>

    <input type="text" name="title" placeholder="Enter title" required>
    <input type="number" name="price" placeholder="Enter price (₦)" required>
    <textarea name="description" placeholder="Describe your listing..." rows="4" required></textarea>

    <button type="submit">Upload Listing</button>
  </form>

  <div id="message"></div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc 
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
import { 
  getAuth 
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBnzsTMXV6o8fNhosp_7U6o3xFEQbsQIl8",
  authDomain: "referral-backend-3a9c3.firebaseapp.com",
  projectId: "referral-backend-3a9c3",
  storageBucket: "referral-backend-3a9c3.appspot.com",
  messagingSenderId: "394999402090",
  appId: "1:394999402090:web:5b77df3f12f00f5ab58413"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app); // ✅ ONLY NEW LINE ADDED

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("uploadForm");
  const message = document.getElementById("message");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const category = document.querySelector('select[name="category"]').value;
    const title = document.querySelector('input[name="title"]').value.trim();
    const price = document.querySelector('input[name="price"]').value.trim();
    const description = document.querySelector('textarea[name="description"]').value.trim();

    if (!category || !title || !price || !description) {
      message.innerHTML = '<div class="error">⚠️ Please fill in all fields.</div>';
      return;
    }

    const user = auth.currentUser; // ✅ GET LOGGED IN USER

    if (!user) {
      message.innerHTML = '<div class="error">⚠️ You must be logged in to upload.</div>';
      return;
    }

    try {
      const listingReferralCode = Math.random().toString(36).substring(2, 10);

      // ✅ ✅ ✅ ONLY THIS OBJECT WAS MODIFIED
      await addDoc(collection(db, "listings"), {
        category,
        title,
        price,
        description,
        referralCode: listingReferralCode,
        userId: user.uid,          // ✅ ✅ ✅ THIS IS THE FIX
        createdAt: new Date()
      });

      message.innerHTML = '<div class="success">✅ Listing saved successfully!</div>';
      form.reset();
    } catch (err) {
      console.error("Firestore error:", err);
      message.innerHTML = '<div class="error">⚠️ Error saving listing: ' + err.message + '</div>';
    }
  });
});
</script>

</body>
</html>

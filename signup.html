<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign Up - REFERALLS</title>
  <link rel="stylesheet" href="./assets/css/access.css">
</head>
<body class="reg">
  <div class="container">
    <h2>Create Account</h2>
    <input type="text" id="username" placeholder="Username" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button id="signupBtn">Sign Up</button>
    <p>Already have an account? <a href="login.html">Login</a></p>
  </div>

<script type="module">
/*
  Correct signup script.
  Assumes ./firebase.js exports: `auth` and `db`.
*/
import { auth, db } from "./firebase.js";
import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import {
  doc,
  setDoc,
  collection,
  query,
  where,
  getDocs,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

// grab referral code from URL (if any)
const urlParams = new URLSearchParams(window.location.search);
const referralCode = urlParams.get("ref"); // may be null

async function signup() {
  const username = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!username || !email || !password) {
    alert("Please fill in all fields");
    return;
  }

  try {
    // Create user in Firebase Auth
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    const userId = userCred.user.uid;

    // Generate referral code for this user
    const myReferralCode = Math.random().toString(36).substring(2, 10);

    // Save user document in Firestore with UID as the document id
    await setDoc(doc(db, "users", userId), {
      uid: userId,
      username,
      email,
      referralCode: myReferralCode,
      referredBy: referralCode || null,
      points: 0,
      isAdmin: false,
      createdAt: new Date()
    });

    // If they came via a listing/user referral, increment the referrer's points
    if (referralCode) {
      // find the user who owns this referral code
      const q = query(collection(db, "users"), where("referralCode", "==", referralCode));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        const refDoc = snapshot.docs[0];
        const prevPoints = refDoc.data().points || 0;
        await updateDoc(refDoc.ref, { points: prevPoints + 20 });
      }
    }

    alert("âœ… Account created successfully! Please login.");
    // keep your original flow: go to login page after signup
    window.location.href = "login.html";

  } catch (err) {
    // friendly error and console details
    alert("Error: " + (err.message || err));
    console.error("Signup error:", err);
  }
}

document.getElementById("signupBtn").addEventListener("click", signup);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - REFERALLS</title>
<link rel="stylesheet" href="./assets/css/admin.css">
</head>
<body>

<header>
  <h1>Admin Dashboard - REFERALLS</h1>
</header>

<div class="table-wrapper">
    <button class="back-btn" onclick="window.location.href='index.html'">← Back to Dashboard</button>
  <h2>All Users</h2>
  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Email</th>
        <th>Points</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>

  <h2>All Listings</h2>
  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Category</th>
        <th>Price</th>
        <th>Referral Code</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="listingsTable"></tbody>
  </table>

  <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

const usersTable = document.getElementById("usersTable");
const listingsTable = document.getElementById("listingsTable");
const logoutBtn = document.getElementById("logoutBtn");

// Logout
logoutBtn.onclick = async () => {
  await signOut(auth);
  window.location.href = "login.html";
};

// Only allow admin access
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Please login first");
    window.location.href = "login.html";
    return;
  }

  const userDocRef = doc(db, "users", user.uid);
  const userSnap = await getDocs(collection(db, "users"));
  const adminCheck = userSnap.docs.find(d => d.id === user.uid)?.data()?.isAdmin;

  if (!adminCheck) {
    alert("Access denied! Admins only.");
    await signOut(auth);
    window.location.href = "login.html";
    return;
  }

  // Load users and listings once admin is verified
  loadUsers();
  loadListings();
});

// Load all users
async function loadUsers() {
  usersTable.innerHTML = "";
  const usersSnapshot = await getDocs(collection(db, "users"));
  usersSnapshot.forEach(userDoc => {
    const userData = userDoc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${userData.username || "-"}</td>
      <td>${userData.email || "-"}</td>
      <td>${userData.points || 0}</td>
    `;
    usersTable.appendChild(tr);
  });
}

// Load all listings
async function loadListings() {
  listingsTable.innerHTML = "";
  const listingsSnapshot = await getDocs(collection(db, "listings"));
  listingsSnapshot.forEach(listingDoc => {
    const listing = listingDoc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${listing.title || "-"}</td>
      <td>${listing.category || "-"}</td>
      <td>₦${listing.price || 0}</td>
      <td>${listing.referralCode || "-"}</td>
      <td><button onclick="deleteListing('${listingDoc.id}')">Delete</button></td>
    `;
    listingsTable.appendChild(tr);
  });
}

// Delete listing
window.deleteListing = async (id) => {
  if (confirm("Are you sure you want to delete this listing?")) {
    await deleteDoc(doc(db, "listings", id));
    alert("Listing deleted");
    loadListings();
  }
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard - REFERALLS</title>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    margin: 0;
  }

  .dashboard-container {
    background: white;
    padding: 30px;
    border-radius: 10px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
  }

  h2 {
    color: #008000;
  }

  .info {
    text-align: left;
    margin: 15px 0;
  }

  .info p {
    font-size: 16px;
    margin: 8px 0;
  }

  .referral-box {
    background: #f0fff0;
    padding: 10px;
    border: 1px solid #cceccc;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    word-break: break-all;
  }

  button {
    padding: 10px 20px;
    margin-top: 20px;
    background: #ffa500;
    border: none;
    color: white;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
  }

  .logout-btn {
    background: #e60000;
    width: 100%;
  }

  a {
    text-decoration: none;
    color: #008000;
    font-weight: bold;
  }

  /* Analytics section */
  .analytics-container {
    margin-top: 30px;
    padding: 15px;
    border: 1px solid #cceccc;
    border-radius: 8px;
    background: #f9f9f9;
  }

  canvas {
    margin-top: 15px;
  }

  /* Responsive tweaks */
  @media screen and (max-width: 600px) {
    body {
      padding: 10px;
    }
    .dashboard-container {
      width: 100%;
      padding: 20px;
    }
  }
</style>
</head>
<body>
  <div class="dashboard-container">
    <h2>üë§ Your Proffile</h2>
    <div class="info">
      <p><strong>Username:</strong> <span id="username"></span></p>
      <p><strong>Email:</strong> <span id="email"></span></p>
      <p><strong>Referral Points:</strong> <span id="points">0</span></p>
      <p><strong>Your Referral Link:</strong></p>
      <div class="referral-box">
        <span id="referralLink"></span>
        <button onclick="copyReferral()">Copy</button>
      </div>
    </div>

    <div class="analytics-container">
      <h3>üìä Your Activity</h3>
      <canvas id="activityChart" width="400" height="200"></canvas>
    </div>

    <button class="logout-btn" onclick="logout()">Logout</button>
    <p><a href="index.html">‚Üê Back to Home</a></p>
  </div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

// Make functions global
window.copyReferral = async function() {
  const text = document.getElementById("referralLink").innerText;
  try {
    await navigator.clipboard.writeText(text);
    alert("Referral link copied!");
  } catch (err) {
    alert("Failed to copy referral link: " + err);
  }
};

window.logout = async function() {
  try {
    await signOut(auth);
    localStorage.removeItem("user"); 
    alert("You have been logged out");
    window.location.href = "login.html";
  } catch (err) {
    alert("Error logging out: " + err.message);
    console.error(err);
  }
};

// Firebase Auth state
onAuthStateChanged(auth, async (firebaseUser) => {
  if (!firebaseUser) {
    alert("Please log in first.");
    window.location.href = "login.html";
    return;
  }

  document.getElementById("username").innerText = firebaseUser.displayName || "User";
  document.getElementById("email").innerText = firebaseUser.email;

  const docRef = doc(db, "users", firebaseUser.uid);
  const docSnap = await getDoc(docRef);

  let points = 0;
  let referralCode = firebaseUser.uid;

  if (docSnap.exists()) {
    const userData = docSnap.data();
    points = userData.points || 0;
    referralCode = userData.referralCode || firebaseUser.uid;
  }

  document.getElementById("points").innerText = points;

  const referralLink = `${window.location.origin}/signup.html?ref=${encodeURIComponent(referralCode)}`;
  const linkEl = document.getElementById("referralLink");
  linkEl.innerHTML = `<a href="${referralLink}" target="_blank">${referralLink}</a>`;

  // üîπ Load activity chart
  loadActivityChart(firebaseUser.uid);
});

// Load activity chart
async function loadActivityChart(uid) {
  // Simulated data, replace with real user activity from Firestore if available
  let activityData = {
    buys: 3,
    sells: 5,
    referrals: 2
  };

  // Example: fetch from Firestore
  // const listingsSnap = await getDocs(query(collection(db, "listings"), where("uid","==",uid)));
  // activityData.sells = listingsSnap.size;

  const ctx = document.getElementById('activityChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Buys', 'Sells', 'Referrals'],
      datasets: [{
        label: 'Activity',
        data: [activityData.buys, activityData.sells, activityData.referrals],
        backgroundColor: ['#008000','#ffa500','#0b3fea'],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        title: {
          display: true,
          text: 'Your Activity Summary'
        }
      }
    }
  });
}
</script>
</body>
</html>
